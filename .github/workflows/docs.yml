name: Deploy Documentation

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Documentation updates on:
# - Every push to main/master branch (latest docs always reflect main)
# - Manual dispatch (workflow_dispatch)
# Docs do NOT update on PRs or feature branch pushes

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    # Only deploy docs on main branch pushes (not on PRs or feature branches)
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Install Doxygen and Graphviz
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz
    - name: Generate latest documentation
      run: doxygen Doxyfile
    
    - name: Get all version tags
      id: get_versions
      run: |
        # Get all version tags, sorted by version (newest first)
        VERSIONS=$(git tag -l "v*.*.*" | sort -V -r)
        echo "versions<<EOF" >> $GITHUB_OUTPUT
        echo "$VERSIONS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Build versioned documentation structure
      run: |
        mkdir -p docs/versioned
        chmod +x scripts/build_versioned_docs.sh
        
        # Generate latest docs structure
        ./scripts/build_versioned_docs.sh
        
        # Generate docs for each tagged version
        VERSIONS="${{ steps.get_versions.outputs.versions }}"
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        
        for tag in $VERSIONS; do
          echo "Generating docs for ${tag}..."
          
          # Checkout the tag (need full history)
          git fetch --tags --force
          git checkout ${tag} --quiet || { echo "Skipping ${tag}"; continue; }
          
          # Generate docs for this version
          doxygen Doxyfile || { echo "Failed to generate docs for ${tag}"; git checkout ${CURRENT_BRANCH} --quiet; continue; }
          
          # Copy to versioned directory
          mkdir -p "docs/versioned/${tag}"
          cp -r docs/html/* "docs/versioned/${tag}/" || true
          
          # Inject version switcher into all docs pages
          chmod +x scripts/inject_version_switcher.sh
          ./scripts/inject_version_switcher.sh "docs/versioned/${tag}" "docs/versioned" || true
          
          # Return to original branch
          git checkout ${CURRENT_BRANCH} --quiet
        done
    
    - name: Update index.html dropdown with available versions
      run: |
        # Get list of available versions from directories
        VERSIONS=$(find docs/versioned -maxdepth 1 -type d -name "v*" | sed 's|.*/||' | sort -V -r)
        
        if [ -n "$VERSIONS" ]; then
          # Build version options HTML in a temp file to avoid YAML issues
          TEMP_OPTS=$(mktemp)
          echo '<option value="latest">Latest (main branch)</option>' > "$TEMP_OPTS"
          for v in $VERSIONS; do
            echo "                <option value=\"${v}\">${v}</option>" >> "$TEMP_OPTS"
          done
          
          # Update index.html using perl for reliable multi-line replacement
          perl -i -pe '
            BEGIN { 
              undef $/;
              open(F, "'"$TEMP_OPTS"'");
              $opts = <F>;
              close(F);
            }
            s|<select id="version-select"[^>]*>.*?</select>|<select id="version-select" onchange="switchVersion()">'"$opts"'    </select>|s;
          ' docs/versioned/index.html || {
            # Fallback: simple sed replacement
            VERSION_OPTIONS=$(cat "$TEMP_OPTS")
            sed -i "s|<option value=\"latest\">Latest (main branch)</option>.*<!-- Versions will be populated by script -->|${VERSION_OPTIONS}|" docs/versioned/index.html
          }
          rm -f "$TEMP_OPTS"
        fi
    
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./docs/versioned
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
