name: Deploy Documentation

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*.*.*'  # Also run when version tags are pushed
  workflow_dispatch:

# Documentation updates on:
# - Every push to main/master branch (latest docs always reflect main)
# - When version tags are pushed (generates versioned docs immediately)
# - Manual dispatch (workflow_dispatch)
# Docs do NOT update on PRs or feature branch pushes

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    # Deploy docs on main branch pushes, tag pushes, or manual dispatch
    # When triggered by a tag, we still generate "latest" from main branch
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history to checkout tags
    - name: Ensure we're on main branch for latest docs
      run: |
        # If triggered by a tag, checkout main branch for "latest" docs
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          git checkout main || git checkout master
        fi
    - name: Install Doxygen and Graphviz
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz
    - name: Get all version tags
      id: get_versions
      run: |
        # Get all version tags, sorted by version (newest first)
        VERSIONS=$(git tag -l "v*.*.*" | sort -V -r)
        echo "versions<<EOF" >> $GITHUB_OUTPUT
        echo "$VERSIONS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Build versioned documentation structure
      run: |
        mkdir -p docs/versioned
        chmod +x scripts/build_versioned_docs.sh
        chmod +x scripts/inject_version_switcher.sh
        
        # Generate latest docs structure (without injecting switcher yet - we'll do it after all versions are ready)
        echo "Building latest documentation"
        doxygen Doxyfile
        rm -rf docs/versioned/latest
        cp -r docs/html docs/versioned/latest
        
        # Generate docs for each tagged version
        VERSIONS="${{ steps.get_versions.outputs.versions }}"
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        
        for tag in $VERSIONS; do
          echo "Generating docs for ${tag}..."
          
          # Checkout the tag (need full history)
          git fetch --tags --force
          git checkout ${tag} --quiet || { echo "Skipping ${tag}"; continue; }
          
          # Generate docs for this version
          doxygen Doxyfile || { echo "Failed to generate docs for ${tag}"; git checkout ${CURRENT_BRANCH} --quiet; continue; }
          
          # Copy to versioned directory
          mkdir -p "docs/versioned/${tag}"
          cp -r docs/html/* "docs/versioned/${tag}/" || true
          
          # Return to original branch
          git checkout ${CURRENT_BRANCH} --quiet
        done
        
        # Now inject version switcher into ALL directories (latest + all versions)
        # This ensures the dropdown has all available versions
        echo "Injecting version switcher into all documentation..."
        ./scripts/inject_version_switcher.sh "docs/versioned/latest" "docs/versioned"
        for tag in $VERSIONS; do
          if [ -d "docs/versioned/${tag}" ]; then
            ./scripts/inject_version_switcher.sh "docs/versioned/${tag}" "docs/versioned" || true
          fi
        done
        
        # Create redirect index page
        printf '%s\n' \
          '<!DOCTYPE html>' \
          '<html lang="en">' \
          '<head>' \
          '    <meta charset="UTF-8">' \
          '    <meta http-equiv="refresh" content="0; url=./latest/index.html">' \
          '    <title>Game Audio Module - Documentation</title>' \
          '    <script>' \
          '        window.location.href = '\''./latest/index.html'\'';' \
          '    </script>' \
          '</head>' \
          '<body>' \
          '    <p>Redirecting to <a href="./latest/index.html">latest documentation</a>...</p>' \
          '</body>' \
          '</html>' > docs/versioned/index.html
    
    
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v4
      with:
        path: ./docs/versioned
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
